# 自动重试和多次调度功能说明

## 功能概述

为了提高签到成功率，系统现在支持：

1. **自动重试机制**：失败后自动重试3次（**所有运行方式均支持**）⭐v3.7.3升级
2. **多次调度**：每天多个时间点运行（定时任务模式）
3. **智能跳过**：签到成功后自动跳过后续运行

## 重试机制适用范围

| 运行方式 | 是否支持重试 | 版本 |
|---------|------------|------|
| **Web控制面板手动启动** | ✅ 支持 | v3.7.3+ |
| **定时任务自动运行** | ✅ 支持 | v3.6+ |
| **直接运行脚本** | ✅ 支持 | v3.7.3+ |

> 💡 **从 v3.7.3 开始，所有运行方式都支持自动重试！**

## 配置说明

### 1. 启用定时任务

在 `config.json` 中设置：

```json
{
  "enable_scheduler": true,
  "schedule_times": [
    "03:00",
    "09:00", 
    "15:00",
    "21:00"
  ]
}
```

### 2. 配置参数说明

| 参数 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| `enable_scheduler` | boolean | 是否启用定时任务 | `false` |
| `schedule_times` | array | 每天运行的时间点列表 | `["03:00", "09:00", "15:00", "21:00"]` |

### 3. 兼容性说明

如果你的配置文件中使用的是旧的 `schedule_time` 参数（单个时间），系统会自动兼容：

```json
{
  "enable_scheduler": true,
  "schedule_time": "03:00"  // 旧版配置，仍然有效
}
```

## 工作流程

### 0. Web界面手动启动 ⭐v3.7.3新增

从Web控制面板点击"启动机器人"时，也会自动应用重试机制：

```
用户点击启动
├─ 检查今天是否已签到
│   ├─ 是 → 跳过运行
│   └─ 否 → 开始第1次尝试
│       ├─ 成功 → 完成
│       └─ 失败 → 5分钟后第2次尝试
│           ├─ 成功 → 完成
│           └─ 失败 → 5分钟后第3次尝试
│               ├─ 成功 → 完成
│               └─ 失败 → 任务结束
```

> **重要提示：** 
> - Web界面启动时，重试过程中页面会显示"运行中"状态
> - 可以随时点击"停止机器人"中断重试
> - 重试日志会实时显示在日志面板中

### 1. 定时任务自动触发

系统会在配置的时间点自动触发任务：
- 凌晨 3:00（夜间低峰期）
- 上午 9:00（工作时间）
- 下午 3:00（下午时段）
- 晚上 9:00（晚间活跃期）

### 2. 智能检测

每次运行前会先检查：
```
今天是否已经签到成功？
├─ 是 → 跳过本次运行，输出日志
└─ 否 → 开始执行任务
```

### 3. 自动重试

如果任务执行失败，会自动重试：

```
第1次尝试
├─ 成功 → 检查签到状态
│   ├─ 已签到 → 完成，今天不再运行
│   └─ 未签到 → 等待5分钟后重试
└─ 失败 → 等待5分钟后第2次尝试
    └─ 失败 → 等待5分钟后第3次尝试
        └─ 失败 → 本次任务结束，等待下一个时间点
```

### 4. 重试参数

- **最大重试次数**：3次
- **重试间隔**：300秒（5分钟）
- **总耗时**：最多约15分钟（3次 × 5分钟）

## 运行示例

### 成功场景

```
⏰ 定时任务触发，开始运行机器人...
🔐 开始自动登录...
✅ 登录成功！
💬 自动回帖完成！共回复 5 个帖子
📅 已完成回复，现在开始签到...
✅ 签到成功
✅ 定时任务执行成功
🎉 签到已完成，今天不再运行
```

### 首次失败，重试成功场景

```
⏰ 定时任务触发，开始运行机器人...
❌ 找不到用户名输入框
❌ 第 1 次尝试失败
⏰ 300秒后进行第 2 次重试...

🔄 第 2/3 次尝试...
✅ 登录成功！
💬 自动回帖完成！
✅ 签到成功
🎉 签到已完成，今天不再运行
```

### 已签到，智能跳过场景

```
⏰ 定时任务触发，开始运行机器人...
✅ 今天已经签到成功，跳过本次运行
```

## 日志查看

### 查看实时日志

```bash
# Linux/Mac
tail -f logs/scheduler.log

# Windows PowerShell
Get-Content logs/scheduler.log -Wait -Tail 50
```

### 日志文件位置

- **调度器日志**：`logs/scheduler.log`
- **机器人日志**：`logs/selenium_bot.log`
- **统计数据**：`data/stats.json`

## 统计数据

签到状态记录在 `data/stats.json` 中：

```json
{
  "today": "2025-10-27",
  "reply_count": 5,
  "checkin_success": true,
  "checkin_time": "2025-10-27 03:15:42",
  "replies": [...]
}
```

## 常见问题

### Q1: 为什么要设置多个时间点？

**A:** 提高成功率。如果某个时间点因为网络问题或其他原因失败，还有其他时间点可以尝试。

### Q2: 会不会重复签到？

**A:** 不会。系统会检测今天是否已经签到成功，如果已成功会自动跳过。

### Q3: 重试间隔可以修改吗？

**A:** 可以。编辑 `scheduler.py` 文件中的 `retry_delay` 参数（默认300秒）。

### Q4: 如何只在一个时间点运行？

**A:** 修改配置文件：

```json
{
  "enable_scheduler": true,
  "schedule_times": ["03:00"]
}
```

### Q5: 如何临时禁用某个时间点？

**A:** 从 `schedule_times` 数组中删除该时间点即可：

```json
{
  "schedule_times": [
    "03:00",
    "09:00"
    // "15:00",  // 已注释
    // "21:00"   // 已注释
  ]
}
```

## 最佳实践

### 1. 时间选择建议

- **凌晨 3:00**：夜间低峰期，网络稳定
- **上午 9:00**：第一次备份时间
- **下午 3:00**：第二次备份时间
- **晚上 9:00**：最后的备份时间

### 2. 重试次数建议

- 默认3次已经足够
- 如果网络不稳定，可以增加到5次

### 3. 监控建议

- 定期检查日志文件
- 关注 `data/stats.json` 中的签到记录
- 如果连续多天失败，检查账号状态

## 故障排查

### 问题：所有时间点都失败

**可能原因：**
1. 账号密码错误
2. 网络连接问题
3. 论坛维护或更改了页面结构

**解决方案：**
1. 检查 `config.json` 中的账号信息
2. 测试网络连接：`ping sehuatang.org`
3. 查看日志文件了解详细错误
4. 尝试手动登录网站确认账号状态

### 问题：签到成功但显示未完成

**可能原因：**
签到成功后没有正确记录

**解决方案：**
检查 `selenium_auto_bot.py` 中是否调用了 `self.stats.mark_checkin_success()`

### 问题：定时任务没有运行

**可能原因：**
1. `enable_scheduler` 未设置为 `true`
2. 调度器进程未启动

**解决方案：**
1. 检查 `config.json` 配置
2. 运行调度器：`python scheduler.py`
3. 确保进程一直运行（可使用 supervisor 或 systemd）

## 更新日志

### v1.4.0 (2025-10-30) - 对应主版本 v3.7.4
- ⚡ 新增：配置实时生效功能 - Web界面修改后自动重载定时任务
- 🔄 新增：每60秒自动检测配置文件变更
- 📊 优化：启动时清晰显示当前调度模式（Cron/多时间/单一时间）
- 💡 优化：保存配置时立即显示重载状态
- 🛡️ 优化：完全向下兼容旧版配置格式

### v1.3.0 (2025-10-29) - 对应主版本 v3.7.3
- ✨ 新增：Web界面手动启动支持自动重试
- ✨ 新增：所有运行方式统一重试逻辑
- 📊 优化：重试过程日志更详细清晰
- 🎯 优化：签到成功检测更精准
- 🐛 修复：版本号显示问题（从GitHub远程读取）

### v1.2.0 (2025-10-29) - 对应主版本 v3.7.2
- 📐 优化：Web界面布局优化
- 🎨 优化：配置页面卡片排列

### v1.1.0 (2025-10-27)
- ✨ 新增：自动重试机制（最多3次）
- ✨ 新增：多时间点调度支持
- ✨ 新增：智能签到状态检测
- ✨ 优化：更详细的日志输出
- 🐛 修复：兼容旧版单时间点配置

## 相关文档

- [README_SCHEDULER.md](README_SCHEDULER.md) - 定时任务基础说明
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - 故障排查指南
- [配置说明.md](配置说明.md) - 完整配置文档

