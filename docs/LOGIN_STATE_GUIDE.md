# 登录状态保存功能说明

## 🎯 功能概述

AW98tang 已实现登录状态保存功能，使用 Cookies 技术保存登录信息，避免每次运行都需要重新登录。

---

## ✨ 工作原理

### 登录流程

```
首次运行:
┌─────────────────────────────────────┐
│ 1. 检查是否存在 cookies 文件       │
│    ❌ 不存在                         │
│                                      │
│ 2. 执行账号密码登录                 │
│    ✅ 输入用户名、密码、安全问题答案 │
│                                      │
│ 3. 登录成功后保存 Cookies           │
│    💾 保存到 data/cookies.pkl       │
└─────────────────────────────────────┘

后续运行:
┌─────────────────────────────────────┐
│ 1. 检查是否存在 cookies 文件       │
│    ✅ 存在: data/cookies.pkl        │
│                                      │
│ 2. 加载 Cookies 到浏览器            │
│    📂 读取并应用所有 cookies        │
│                                      │
│ 3. 验证登录状态                     │
│    🔍 快速检查当前页面              │
│    🔍 访问个人中心确认              │
│                                      │
│ 4a. 如果登录有效                    │
│     ✅ 直接使用，跳过登录           │
│                                      │
│ 4b. 如果登录已过期                  │
│     ⚠️ 删除旧 cookies 文件          │
│     🔐 重新执行账号密码登录         │
│     💾 保存新的 cookies             │
└─────────────────────────────────────┘
```

---

## 📂 文件位置

```
AW98tang/
├── data/
│   └── cookies.pkl        # 保存的登录状态文件
├── logs/
│   └── selenium_bot.log   # 详细日志（查看登录过程）
└── selenium_auto_bot.py   # 核心程序
```

---

## 🔍 如何确认是否使用了保存的登录状态

### 方法1: 查看日志输出

启动机器人时，查看终端或日志文件，会看到以下信息：

#### 使用保存的登录状态（成功）
```
============================================================
🔍 发现已保存的登录状态文件！
📂 文件位置: data/cookies.pkl
🔄 尝试恢复登录状态...
============================================================
🌐 正在访问网站...
✅ 登录状态已加载
📝 Cookies已加载，正在验证登录状态...
✅ 快速检测到已登录状态（用户: YourUsername）
============================================================
🎉 登录状态验证成功！
✅ 无需重新登录，直接使用已保存的登录状态
============================================================
```

#### 登录状态过期（需要重新登录）
```
============================================================
🔍 发现已保存的登录状态文件！
📂 文件位置: data/cookies.pkl
🔄 尝试恢复登录状态...
============================================================
🌐 正在访问网站...
✅ 登录状态已加载
📝 Cookies已加载，正在验证登录状态...
🔍 快速检查未通过，访问个人中心确认登录状态...
ℹ️ 已跳转到登录页面，登录状态已过期
============================================================
⚠️ 登录状态已过期或失效
🗑️ 正在删除过期的登录状态文件...
✅ 已删除过期文件，准备重新登录
============================================================
🔐 开始账号密码登录流程...
```

#### 首次运行（无保存的登录状态）
```
ℹ️ 未找到已保存的登录状态，将执行首次登录
============================================================
🔐 开始账号密码登录流程...
============================================================
```

---

## ⏱️ Cookies 有效期

### 正常情况

- **论坛Cookie有效期**: 通常为 **7-30天**（取决于论坛设置）
- **实际使用**: 如果每天都运行机器人，理论上可以一直保持登录状态

### 失效情况

Cookies可能失效的原因：
1. ⏰ **超过有效期**: 长时间未运行机器人
2. 🔐 **账号密码修改**: 在其他地方修改了密码
3. 🛡️ **安全策略**: 论坛检测到异常登录
4. 🌐 **IP地址变更**: 网络环境发生变化
5. 🧹 **手动清理**: 删除了 `data/cookies.pkl` 文件
6. 🔄 **论坛维护**: 论坛更新导致Session失效

---

## 🔧 故障排查

### 问题1: 每次都重新登录

**症状**: 日志中始终显示"开始账号密码登录流程"

**可能原因**:
1. `data/cookies.pkl` 文件不存在或被删除
2. Cookies加载失败
3. 登录状态验证逻辑失败

**排查步骤**:

#### 步骤1: 检查文件是否存在
```bash
# Windows
dir data\cookies.pkl

# Linux/Mac
ls -la data/cookies.pkl
```

如果文件不存在，说明：
- 这是首次运行
- 或文件被删除了
- 或上次登录失败，未保存

#### 步骤2: 查看详细日志
```bash
# 查看最新的日志
tail -f logs/selenium_bot.log

# Windows PowerShell
Get-Content logs/selenium_bot.log -Tail 50
```

关注以下关键信息：
- 是否显示"发现已保存的登录状态文件"
- 是否显示"Cookies已加载"
- 是否显示"快速检测到已登录状态"
- 如果显示"快速检查未通过"，后续发生了什么

#### 步骤3: 检查Cookies文件权限
```bash
# Linux/Mac - 确保有读写权限
chmod 644 data/cookies.pkl

# Windows - 确保当前用户有读写权限
```

#### 步骤4: 手动删除Cookies文件重新生成
```bash
# 删除可能损坏的cookies文件
rm data/cookies.pkl  # Linux/Mac
del data\cookies.pkl  # Windows

# 重新运行机器人，会重新登录并保存
```

---

### 问题2: 登录状态验证失败

**症状**: 日志显示"快速检查未通过"或"未检测到登录状态"

**原因**: 登录状态检查逻辑可能误判

**最新优化**（v3.5）:
- ✅ 增加快速检查（检查当前页面）
- ✅ 降级检查（访问个人中心确认）
- ✅ 多种登录标识判断
- ✅ URL跳转检测

**如果仍然失败**:

1. **查看是否真的已登录**
   - 运行后不要立即关闭浏览器
   - 手动检查浏览器页面是否显示用户名
   - 查看是否能访问个人中心

2. **论坛特殊处理**
   - 某些论坛可能有特殊的登录验证
   - 可能需要二次验证（如验证码）
   - 可能限制了Cookie的使用

---

### 问题3: Docker环境下Cookies丢失

**症状**: 容器重启后又要重新登录

**原因**: `data/` 目录没有正确挂载

**解决方案**: 检查 `docker-compose.yml`

```yaml
volumes:
  - ./AW98tang/data:/app/data  # ✅ 必须挂载data目录
```

确保数据卷配置正确：
```bash
# 检查挂载
docker-compose exec AW98tang ls -la data/

# 应该看到 cookies.pkl 文件
```

---

## 💡 最佳实践

### 1. 定期运行

**推荐**: 至少每周运行一次，保持登录状态活跃

```bash
# 使用定时任务
# Linux crontab
0 3 * * * cd /path/to/AW98tang && python selenium_auto_bot.py

# 或使用内置定时功能
{
  "enable_scheduler": true,
  "schedule_time": "03:00"
}
```

### 2. 备份Cookies文件

```bash
# 定期备份登录状态
cp data/cookies.pkl data/cookies.pkl.backup

# 出问题时恢复
cp data/cookies.pkl.backup data/cookies.pkl
```

### 3. 监控日志

定期检查 `logs/selenium_bot.log`，关注：
- 是否频繁重新登录
- 是否出现登录失败
- Cookies加载是否正常

### 4. Docker部署注意事项

```yaml
# docker-compose.yml 正确配置
volumes:
  - ./AW98tang/config.json:/app/config.json
  - ./AW98tang/logs:/app/logs
  - ./AW98tang/debug:/app/debug
  - ./AW98tang/data:/app/data  # ✅ 关键：data目录必须挂载
```

---

## 🔐 安全建议

### 1. 保护Cookies文件

```bash
# Linux/Mac - 限制文件权限
chmod 600 data/cookies.pkl

# 只有当前用户可以读写
```

### 2. 不要分享Cookies文件

⚠️ **警告**: `cookies.pkl` 包含你的登录凭证，不要：
- 上传到GitHub等公开平台
- 分享给他人
- 在不安全的环境中使用

### 3. 定期更新密码

建议定期修改论坛密码，增强安全性。修改后：
1. 删除 `data/cookies.pkl`
2. 重新运行机器人
3. 使用新密码登录

---

## 📊 登录状态检查逻辑

### v3.5 更新 - 多层次验证

#### 第一层：快速检查（当前页面）
```python
# 检查项
✅ 是否包含"退出"链接
✅ 是否包含用户名class
✅ 是否显示用户名
```

#### 第二层：详细检查（访问个人中心）
```python
# 访问个人中心页面
profile_url = "home.php?mod=space&do=profile"

# 检查项
✅ 是否跳转到登录页面（未登录标志）
✅ 页面是否包含"退出"、"个人资料"
✅ 页面是否包含用户名
```

#### 第三层：降级检查（URL判断）
```python
# 如果前两层失败，检查URL
✅ 如果没有跳转到登录页面，认为已登录
```

---

## 🎁 技巧和提示

### 查看Cookies内容（调试用）

```python
# 可以手动查看cookies.pkl内容
import pickle

with open('data/cookies.pkl', 'rb') as f:
    cookies = pickle.load(f)
    for cookie in cookies:
        print(f"Name: {cookie['name']}, Value: {cookie['value'][:20]}...")
```

### 强制重新登录

```bash
# 删除cookies文件
rm data/cookies.pkl

# 或在配置中添加（临时）
{
  "force_relogin": true
}
```

### 测试登录状态

运行机器人后立即停止，检查：
1. `data/cookies.pkl` 是否存在
2. 文件大小是否正常（通常几KB）
3. 再次运行，查看是否使用保存的登录状态

---

## 🔄 版本历史

- **v3.1** - 首次实现登录状态保存功能
- **v3.5** - 优化登录状态验证逻辑
  - 增加快速检查
  - 增加详细检查（访问个人中心）
  - 增加降级检查
  - 完善日志输出

---

## ❓ 常见问题

### Q: 为什么有时候用保存的登录状态，有时候重新登录？

**A**: 这是正常的。登录状态会过期，系统会自动检测并在需要时重新登录。

### Q: 可以手动触发重新登录吗？

**A**: 删除 `data/cookies.pkl` 文件即可。

### Q: Docker环境下为什么每次都重新登录？

**A**: 检查 `docker-compose.yml` 中是否正确挂载了 `data/` 目录。

### Q: 登录状态可以在不同服务器间共享吗？

**A**: 理论上可以复制 `cookies.pkl` 文件，但可能因IP变化导致失效。

---

**祝你使用愉快！再也不用每次都输入密码了！🎉**

